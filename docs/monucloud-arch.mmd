flowchart TD
    subgraph User
      B[Browser\n(Flask UI)]
    end

    B -->|HTTP/HTTPS| A[Flask API server\n(app.py)]
    A -->|enqueue| Q[(Celery Broker\nRedis/RabbitMQ)]
    W[Celery Worker\n(tasks: run scans)] -->|consume| Q
    W -->|boto3 STS AssumeRole\n(External ID)| C[(AWS APIs)]
    A -->|read/write| D[(PostgreSQL)]
    W -->|read/write| D

    subgraph AWS
      C
    end

    classDef svc fill:#eef,stroke:#88a;
    class A,W,D,Q,C svc;

sequenceDiagram
    participant UI as UI
    participant API as Flask API
    participant DB as Postgres
    participant W as Celery Worker
    participant AWS as AWS STS + Services

    UI->>API: POST /api/scans {account:"ALL"}
    API->>DB: insert scan rows (per account)
    API->>W: send tasks (job_id, account_id)
    loop for each account
      W->>DB: fetch role_arn, external_id
      W->>AWS: sts:AssumeRole(RoleArn, ExternalId)
      W->>AWS: call service APIs (EC2/S3/IAM/...)
      W->>DB: upsert findings, resources
    end
    UI->>API: GET /api/findings?account=...
    API->>DB: query findings with filters
    API-->>UI: JSON -> charts/table