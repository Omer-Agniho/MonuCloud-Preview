flowchart TD
  %% NODES
  B[Browser<br/>(Flask UI)]
  A[Flask API server<br/>(app.py)]
  Q[(Celery Broker<br/>Redis/RabbitMQ)]
  W[Celery Worker<br/>(scan tasks)]
  D[(PostgreSQL)]
  C[(AWS APIs)]

  %% SUBGRAPHS
  subgraph User
    B
  end

  subgraph AWS
    C
  end

  %% EDGES
  B -->|HTTP/HTTPS| A
  A -->|enqueue| Q
  W -->|consume| Q
  W -->|STS AssumeRole<br/>(External ID)| C
  A -->|read/write| D
  W -->|read/write| D

  %% OPTIONAL STYLING
  classDef svc fill:#eef,stroke:#88a,stroke-width:1px;
  class A,W,D,Q,C svc;

sequenceDiagram
  participant UI as UI
  participant API as Flask API
  participant DB as Postgres
  participant W as Celery Worker
  participant AWS as AWS STS + Services

  UI->>API: POST /api/scans {account:"ALL"}
  API->>DB: insert scan rows (per account)
  API->>W: enqueue tasks (job_id, account_id)
  loop for each account
    W->>DB: fetch role_arn, external_id
    W->>AWS: STS AssumeRole(RoleArn, ExternalId)
    W->>AWS: Call service APIs (EC2/S3/IAM/…)
    W->>DB: Upsert findings & resources
  end
  UI->>API: GET /api/findings?account=...
  API->>DB: query findings with filters
  API-->>UI: JSON → charts/table
